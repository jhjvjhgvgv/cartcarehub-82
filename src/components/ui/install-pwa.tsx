
import { useState, useEffect } from 'react';
import { Button } from './button';
import { DownloadIcon, SmartphoneIcon } from 'lucide-react';
import { Popover, PopoverContent, PopoverTrigger } from './popover';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function InstallPWA() {
  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isInstalled, setIsInstalled] = useState(false);
  const [showMobileOptions, setShowMobileOptions] = useState(false);

  // Check if the app is already installed
  useEffect(() => {
    // Check if the app is installed via matchMedia
    const checkIsInstalled = () => {
      if (window.matchMedia('(display-mode: standalone)').matches) {
        setIsInstalled(true);
      }
    };

    // Initial check
    checkIsInstalled();

    // Listen for display mode changes
    window.addEventListener('appinstalled', () => {
      setIsInstalled(true);
      setInstallPrompt(null);
    });

    // Capture the install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the default prompt
      e.preventDefault();
      // Store the event for later use
      setInstallPrompt(e as BeforeInstallPromptEvent);
    });

    return () => {
      window.removeEventListener('appinstalled', () => {});
    };
  }, []);

  // Check if on mobile device
  useEffect(() => {
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    setShowMobileOptions(isMobile);
  }, []);

  const handleInstallClick = async () => {
    if (!installPrompt) return;
    
    // Show the install prompt
    await installPrompt.prompt();
    
    // Wait for the user to respond to the prompt
    const choiceResult = await installPrompt.userChoice;
    
    if (choiceResult.outcome === 'accepted') {
      console.log('User accepted the install prompt');
    } else {
      console.log('User dismissed the install prompt');
    }
    
    // Clear the saved prompt as it can't be used again
    setInstallPrompt(null);
  };

  // Don't render anything if the app is already installed
  if (isInstalled) {
    return null;
  }

  if (showMobileOptions) {
    return (
      <Popover>
        <PopoverTrigger asChild>
          <Button 
            className="flex items-center gap-2"
            variant="outline"
          >
            <SmartphoneIcon className="h-4 w-4" />
            Get App
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-[280px]">
          <div className="grid gap-4">
            <div className="space-y-2">
              <h4 className="font-medium leading-none">Get CartCareHub App</h4>
              <p className="text-sm text-muted-foreground">
                Install our native app for the best experience
              </p>
            </div>
            <div className="grid gap-2">
              <a href="#" className="text-sm flex items-center gap-2 p-2 bg-black text-white rounded-md">
                <svg viewBox="0 0 24 24" className="h-5 w-5" fill="white" xmlns="http://www.w3.org/2000/svg">
                  <path d="M17.5608 12.5469C17.5466 9.58714 20.0895 8.12009 20.2131 8.04222C18.7452 5.93337 16.4878 5.65922 15.6952 5.63791C13.8168 5.44222 12.0032 6.7976 11.0468 6.7976C10.0742 6.7976 8.60468 5.65885 7.0242 5.69462C4.98511 5.72977 3.0855 6.8647 2.0129 8.64322C-0.220037 12.258 1.37626 17.7101 3.50353 20.63C4.56482 22.0616 5.80096 23.6682 7.42611 23.6042C9.01196 23.5348 9.6089 22.569 11.5129 22.569C13.4008 22.569 13.9645 23.6042 15.621 23.5614C17.329 23.5348 18.3903 22.1127 19.4129 20.6704C20.6331 19.0003 21.129 17.3724 21.1435 17.2982C21.1016 17.2822 17.5798 15.8974 17.5608 12.5469Z" />
                  <path d="M14.6532 3.75967C15.5129 2.73048 16.0968 1.31113 15.9395 0C14.7147 0.0553484 13.2016 0.811024 12.3129 1.81967C11.5274 2.71274 10.8403 4.16861 11.0129 5.44237C12.371 5.54451 13.7532 4.77241 14.6532 3.75967Z" />
                </svg>
                App Store
              </a>
              <a href="#" className="text-sm flex items-center gap-2 p-2 bg-[#01875f] text-white rounded-md">
                <svg viewBox="0 0 24 24" fill="white" className="h-5 w-5" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14.27 3.37h.012c.126.008.251.016.379.022.055.27.107.059.162.082.317.154.63.314.942.475.197.14.393.28.593.407.142.09.288.17.433.248.072.04.144.078.216.119.072.04.141.088.214.133.79.052.157.105.239.149a9.55 9.55 0 01.471.28c.099.056.198.11.3.156.05.023.101.048.153.068.026.011.05.023.077.031.016 0 .03.006.046.009-.099.312-.173.64-.252.978-.055.233-.11.467-.156.7 0 .017-.002.033-.01.047-.058.01-.113.03-.17.045-.37.104-.73.24-1.1.345-.297.086-.589.196-.886.281-.336.099-.667.214-1.005.298-.03.007-.06.016-.089.026h-.047c-.046-.027-.096-.045-.143-.068a4.562 4.562 0 00-.387-.162 3.152 3.152 0 00-.646-.235c-.162-.04-.32-.096-.481-.133-.033-.007-.07-.011-.104-.021a.11.11 0 01-.03-.014v-.047c.037-.083.083-.161.123-.244.05-.1.097-.201.15-.298.072-.135.156-.263.226-.399.233-.456.431-.924.626-1.392.041-.1.086-.2.13-.298.224-.477.453-.951.682-1.425zm-.91 16.26c-.073 0-.146-.002-.219-.005a3.77 3.77 0 01-.285-.02 3.048 3.048 0 01-.3-.045c-.208-.04-.412-.1-.61-.179-.208-.105-.402-.231-.596-.361-.214-.104-.427-.208-.644-.305H11c-1.004-.405-1.992-.847-2.993-1.27a16.964 16.964 0 00-.714-.305c-.191-.078-.37-.182-.559-.264a6.336 6.336 0 01-.31-.156c-.003 0-.006-.003-.006-.006-.036-.027-.07-.059-.105-.086-.048-.08-.094-.161-.134-.245a1.687 1.687 0 01-.096-.228c-.062-.17-.1-.346-.12-.524-.007-.054-.014-.104-.016-.159v-.133c0-.049.001-.097.007-.145.017-.186.052-.367.116-.54.062-.166.136-.324.245-.465a1.45 1.45 0 01.26-.27c.089-.08.18-.148.273-.22a16.4 16.4 0 011.468-.88c.252-.135.507-.261.76-.393.1-.05.199-.104.299-.156.059-.033.123-.064.183-.092.02-.01.043-.014.063-.026.01-.8.023-.11.033-.019a.277.277 0 01.1.092c.164.253.344.491.524.728.16.218.32.434.488.644.072.086.15.165.224.243.02.104.04.206.059.308.036.177.072.354.102.53.036.208.065.419.094.63.026.202.055.404.078.607.006.055.01.11.016.165.003.04.01.08.01.12 0 .04-.7.08-.013.12-.023.125-.056.246-.086.37-.013.056-.03.112-.046.168-.026.084-.06.164-.9.247-.05.146-.11.292-.169.434a4.65 4.65 0 01-.21.453 3.102 3.102 0 01-.138.25c0 .01-.2.016-.006.02a.348.348 0 01-.103.023h-.011c-.189-.05-.376-.111-.565-.166-.265-.073-.53-.149-.794-.225-.249-.07-.494-.148-.744-.215-.29-.073-.578-.152-.868-.224-.243-.06-.484-.125-.723-.191-.28-.075-.56-.153-.837-.232-.153-.045-.302-.095-.452-.14zm11.49.085c-.116.22-.284.401-.488.541a2.233 2.233 0 01-.592.293 5.463 5.463 0 01-.549.161l-.08.022a2.306 2.306 0 01-.248.065c-.222.047-.446.084-.672.12-.229.036-.459.07-.691.093-.08.008-.161.01-.242.019-.025.003-.05.007-.078.01H21.1a.27.27 0 01-.089-.04c-.075-.042-.15-.088-.221-.136-.088-.06-.177-.118-.265-.177a2.95 2.95 0 01-.235-.165 5.572 5.572 0 01-.348-.265c-.16-.13-.319-.261-.481-.388-.192-.15-.388-.296-.584-.44-.221-.163-.445-.32-.67-.481a19.183 19.183 0 00-.42-.311l-.059-.05c-.01-.008-.016-.02-.026-.03l.006-.013c.083-.06.165-.12.245-.18.146-.109.292-.218.437-.33.262-.229.502-.48.749-.728.15-.15.312-.291.471-.432.02-.016.036-.036.056-.055.173.248.359.486.549.724.248.311.501.617.76.921.117.142.24.278.363.417.043.048.089.094.136.14.026.027.056.05.089.069a.157.157 0 00.062.023h.03c.066-.023.13-.05.194-.076.243-.102.485-.208.73-.303.175-.067.35-.127.53-.182.026-.6.05-.13.076-.013.017 0 .033-.6.05-.006h.013a.212.212 0 01.077.02c.01.006.02.013.03.023z" />
                  <path d="M3.08 3.693c.244.007.485.024.724.057.201.026.399.059.597.105.211.048.419.105.624.175.205.071.404.156.602.245.109.049.215.1.315.156.036.02.07.043.104.063.033.023.063.052.096.075.083.056.166.115.245.175.136.102.272.208.395.324.03.03.056.059.087.086.03.03.06.056.083.087.033.04.066.078.096.12.037.049.07.099.104.15.02.033.04.07.057.104 0 .013.003.023.003.036v.046a1.483 1.483 0 01-.097.23c-.05.108-.106.212-.163.32-.39.072-.08.143-.123.214a.465.465 0 00-.8.195c.003.063.01.127.013.19.003.049.01.098.016.146 0 .017.003.033.003.05v.023c.003.01.003.023.003.036a.696.696 0 01-.073.151 2.538 2.538 0 01-.133.195c-.075.095-.153.191-.235.28-.104.114-.218.219-.328.325-.016.017-.036.03-.05.046-.006 0-.01 0-.013.007-.023-.027-.049-.053-.07-.08a3.493 3.493 0 01-.204-.29c-.08-.13-.158-.265-.225-.405-.013-.027-.023-.057-.036-.083-.03-.067-.06-.131-.08-.202-.05-.156-.096-.315-.134-.474a5.76 5.76 0 01-.082-.399 4.68 4.68 0 01-.07-.474 4.33 4.33 0 01-.01-.229v-.075c0-.069.006-.14.013-.209.01-.16.03-.318.056-.474.03-.166.063-.335.11-.497.049-.175.106-.348.18-.514.073-.165.162-.32.261-.465.099-.142.211-.271.336-.387.11-.105.235-.195.363-.278.109-.07.219-.133.33-.202a.28.28 0 01.089-.046c.01-.3.017-.3.027-.003h.006c.073.023.146.05.219.076zm18.651 7.926a.338.338 0 01.099.027c.221.062.435.145.641.245.205.099.401.215.584.348.172.124.334.265.481.414.123.13.24.265.334.411.036.059.07.115.1.178.02.033.039.066.055.102.02.04.036.08.05.12.033.086.06.176.082.264.007.027.014.057.017.083.003.01.003.023.003.033v.046c-.3.057-.13.111-.27.165-.5.191-.155.354-.231.53-.135.313-.3.613-.456.914-.149.291-.315.572-.474.859-.16.287-.325.57-.498.844-.1.158-.214.307-.328.455-.129.17-.268.33-.407.494a8.655 8.655 0 01-.384.43c-.124.134-.245.271-.368.405-.043.046-.09.089-.132.135-.027.03-.058.057-.085.086a.13.13 0 01-.046.036h-.006c-.004 0-.01-.003-.013-.006-.06-.04-.123-.075-.182-.112a6.863 6.863 0 01-.235-.149 3.266 3.266 0 01-.235-.172c-.089-.069-.175-.142-.257-.218a2.962 2.962 0 01-.318-.325 3.245 3.245 0 01-.268-.339 4.9 4.9 0 01-.275-.421 6.547 6.547 0 01-.378-.754c-.095-.221-.182-.445-.254-.671-.016-.05-.03-.098-.043-.148a.142.142 0 01-.016-.06c0-.012.003-.023.006-.035.013-.14.026-.027.04-.04.112-.11.228-.214.344-.32.12-.108.235-.22.368-.315.083-.059.169-.11.255-.165.16-.104.319-.208.478-.305.166-.099.328-.204.485-.32a2.79 2.79 0 00.219-.176c.066-.063.135-.122.198-.188.04-.043.076-.089.116-.135.02-.023.043-.046.063-.07.023-.3.046-.56.066-.089.026-.4.049-.8.072-.12.087-.156.165-.315.232-.474.06-.14.116-.282.152-.431.007-.027.01-.05.017-.077 0-.01 0-.016.003-.026 0-.1.003-.2.003-.03a.142.142 0 01.013-.013zm-10.87 6.068c.23 0 .46.002.69.009h.02c.089.017.18.03.268.05.162.037.32.085.475.142.155.056.305.125.445.205a3.4 3.4 0 01.488.295c.08.05.16.101.235.155l.187.14c.023.02.043.046.066.066.022-.1.047-.23.063-.04.043-.23.086-.46.129-.73.062-.33.125-.63.191-.9.089-.4.188-.73.278-.112.036-.17.073-.3.11-.043.026-.1.05-.23.076-.033a.082.082 0 01.04-.7.179.179 0 01.04.013c.013.004.023.01.036.014.02.006.043.009.063.016a7.55 7.55 0 01.668.192c.215.07.424.15.634.232.076.3.15.06.221.092.057.27.11.053.166.08.066.33.136.059.198.092.127.066.252.14.374.218.076.05.153.099.225.156.17.013.03.03.047.043.076.063.146.133.218.205.083.086.165.165.245.251.089.099.172.205.251.308.072.099.136.201.198.304.047.086.093.169.13.257.027.05.05.102.073.156.04.085.069.172.099.261.04.115.07.235.092.354.021.116.03.235.037.351.002.053.006.105.006.158v.063c-.3.023-.3.042-.7.062-.16.082-.39.161-.69.236-.139.353-.315.69-.491 1.024-.136.261-.283.52-.438.77-.155.252-.325.494-.497.737-.156.217-.325.428-.505.63a6.55 6.55 0 01-.437.498 4.886 4.886 0 01-.384.371c-.153.138-.311.272-.464.407-.093.082-.186.161-.281.24a14.078 14.078 0 01-.735.667c-.04.04-.083.076-.126.112-.03.027-.063.05-.096.076-.116.092-.235.185-.354.274-.122.088-.245.172-.371.257a7.078 7.078 0 01-.35.228c-.066.043-.136.083-.201.123-.24.16-.474.325-.711.484-.3.201-.601.394-.904.584-.275.172-.556.334-.84.484a.93.93 0 01-.059.03c-.1.006-.17.013-.27.013-.016 0-.033 0-.05-.006h-.019c-.03-.007-.063-.013-.093-.023-.04-.01-.076-.027-.116-.04a2.005 2.005 0 01-.134-.056c-.066-.03-.14-.054-.206-.085-.126-.06-.242-.133-.367-.195a4.348 4.348 0 01-.192-.109c-.089-.049-.171-.105-.258-.16a3.402 3.402 0 01-.247-.17c-.082-.057-.16-.119-.235-.186a3.16 3.16 0 01-.217-.184c-.07-.063-.136-.13-.198-.198a3.312 3.312 0 01-.247-.291 3.498 3.498 0 01-.18-.25c-.053-.087-.099-.175-.142-.265a2.965 2.965 0 01-.099-.218 4.605 4.605 0 01-.146-.397c-.043-.14-.08-.281-.116-.425a9.728 9.728 0 01-.133-.584c-.04-.194-.075-.391-.103-.588a12.46 12.46 0 01-.122-.963c-.03-.287-.052-.576-.066-.864a21.43 21.43 0 01-.016-.527c-.002-.14-.009-.278-.012-.414a.388.388 0 00-.017-.106c-.17.006-.33.013-.53.016a7.17 7.17 0 01-.478.023c-.155.006-.308.003-.463.003-.05 0-.1-.003-.152-.003-.026 0-.05-.003-.072-.003-.017-.003-.03-.01-.047-.013-.01-.007-.02-.01-.03-.017a.06.06 0 01-.03-.033c-.003-.01-.003-.016-.003-.026 0-.006 0-.013.003-.02a.105.105 0 01.017-.33.163.163 0 01.04-.04c.036-.03.076-.056.116-.082.069-.47.135-.93.205-.14.192-.142.387-.277.585-.414.229-.16.464-.315.7-.464a10.6 10.6 0 01.671-.417 5.4 5.4 0 01.388-.221c.043-.023.083-.046.126-.066.03-.17.06-.3.09-.046.016-.1.029-.23.046-.03.023-.17.046-.37.066-.56.123-.116.235-.241.347-.364.22-.245.428-.5.636-.751.098-.126.196-.25.291-.377a.81.81 0 00.063-.96.072.072 0 00.003-.053c-.133-.03-.271-.052-.407-.083-.162-.036-.321-.073-.481-.12a3.913 3.913 0 01-.335-.105.826.826 0 01-.162-.066c-.046-.02-.09-.043-.136-.066-.049-.026-.099-.053-.146-.08-.116-.065-.235-.133-.35-.201a4.474 4.474 0 01-.342-.208c-.07-.046-.136-.096-.205-.145-.063-.043-.123-.093-.182-.142-.123-.103-.235-.216-.344-.335a3.337 3.337 0 01-.265-.304 3.521 3.521 0 01-.22-.29c-.04-.057-.077-.116-.11-.176-.033-.056-.059-.115-.088-.17-.03-.057-.056-.116-.08-.176a3.35 3.35 0 01-.062-.172 4.388 4.388 0 01-.094-.294c-.026-.086-.046-.172-.066-.262a5.01 5.01 0 01-.049-.262c-.014-.09-.024-.177-.037-.264a8.076 8.076 0 01-.043-.498c-.01-.14-.01-.278-.006-.417 0-.063.003-.123.006-.182a.272.272 0 00.007-.06c0-.006-.004-.016-.004-.023 0-.006 0-.016.004-.022.003-.14.013-.2.023-.033a.174.174 0 01.047-.047c.039-.3.082-.53.128-.076.096-.5.202-.089.311-.129.241-.082.498-.142.75-.202a10.04 10.04 0 01.76-.169c.043-.1.083-.17.126-.026.123-.026.245-.046.37-.066a12.48 12.48 0 01.776-.11c.264-.03.528-.057.794-.077.278-.023.557-.04.838-.053.172-.006.338-.013.507-.013.12 0 .242-.3.362-.003h.06z" />
                </svg>
                Google Play
              </a>
            </div>
          </div>
        </PopoverContent>
      </Popover>
    );
  }

  // Show simple install button for desktop PWA
  if (installPrompt) {
    return (
      <Button 
        onClick={handleInstallClick} 
        className="flex items-center gap-2"
        variant="outline"
      >
        <DownloadIcon className="h-4 w-4" />
        Install App
      </Button>
    );
  }

  return null;
}
